name: Generate IPL Match

on:
  workflow_dispatch:  # allow manual run
  schedule:
    - cron: "0 4 * * *"   # auto-run every day at 04:00 UTC (adjust if needed)

permissions:
  contents: write

jobs:
  build-and-update:
    runs-on: ubuntu-latest

    steps:
    # -------------------------------------------------
    # CHECKOUT
    # -------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # -------------------------------------------------
    # PYTHON SETUP + CACHE
    # -------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # -------------------------------------------------
    # INSTALL DEPENDENCIES
    # -------------------------------------------------
    - name: Install dependencies
      run: |
        pip install pillow requests

    # -------------------------------------------------
    # RUN GENERATOR SCRIPT
    # -------------------------------------------------
    - name: Run IPL Match Generator
      run: |
        cd generator
        python3 generate_from_api.py

    # -------------------------------------------------
    # COMMIT & FORCE PUSH
    # -------------------------------------------------
    - name: Push updated files
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"

        git add -A

        git commit -m "Automated match update: $(date)" || echo "No changes to commit"

        # ALWAYS force push to avoid non-fast-forward errors
        git push origin HEAD:main --force

